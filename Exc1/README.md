# Масштабирование

## Вертикальное масштабирование

- требует перезапуска подов, что может привести к сбоям в работе приложения
- имеет ограничения на объем выделяемых ресурсов. Одной реплике не может быть выделено ресурсов больше чем имеется у узла, на котором реплика запущена. Большой объем выделенных ресурсов может приводить к чрезмерной фрагментации занятых ресурсов.
- используется для работы приложений, выполняющих ресурсоемкие вычисления.

## Горизонтальное масштабирование

- не требует перезапуска подов
- при неизменности выделенных ресусрво позволяет увеличить плотность подов в кластере
- увеличивает надежность за счет репликации

## Автомасшатибрование кластера

- позволяет регулировать количество выделенных ресурсов под кластер в зависимости от нагрузки
- испоьзуется в случаях, когда рост нагрузки (даже отрицательный) неизвествен или может сильно меняться в течении дня


## выбор способа масштабирования приложений

### Описание проблемы

В процессе эксплуатации минимального решения были выявлиены проблемы в скорости работы приложения и API.
Были выявлены случае аварийной остановки серверных приложений.
В задании не указаны какие-либо ресурсоемкие вычисления, компания несет убытки при сбоях в работе приложения
Задержки и сбои в работе серверных приложений влияют на внешних пользователей (т.е. не на сотрудников компании), что также влечет за собой финансовые и репутационные потери

### Решение

Лучшим выбором для бекенд приложений, работающих с внешними пользователями (и компаниями), будет горизонтальное масшабирование приложения. Это увеличит производительность бекенда и уменьшит время ответа, повысит доступность засчет репликации
Для приложения ns-comp-settlement лучше подойдет вертикальное масштабирование, т.к. приложение прозиводит объемные вычисления и его перезапуск не повлияет на внешних пользователей


## выбор способа масштабирования кластера

### Описание проблемы

В ближайшее время предполагается существенный рост нагрузки в связи с наплывом клиентов по результатам рекламной компании. Объем роста неизвестен
В задании отсутствует информация о использовании компанием облачных решений или ограничений на объем частного облака.

### Решение

Предполагаем, что ресурсов для наращивания достаточно. С учетом нераскрытого понятия "значительного роста нагруки" вычислить даже примерно объем необходимых ресурсов кластера для стабильной работы бекенда не представляется возможным. В связи с чем лучшим решением будет настройка автомасшабирования кластера

# Зоны безопасности

В спринте отстутсвуют какие-либо описания зон безопасности или чего-то подобного. Данный вопрос должен обсуждаться с сотрудниками службы безопасности предприятия и зависит только от требований регулятора и жадности бизнеса. При отсутствии требований, скорее-всего, никаких отедьных зон не будет, т.к. это дорого. При наличии требований кластер будет разделен согласно этим самым стребованиям.

Без товарища майора можно рекомендовать только скрыть кластер за некой системой защиты и контроля трафика, чтобы уменьшить ущерб от некоторых сетевых аттак.

# Ограничение нагрузки

## Описание проблемы

В некоторые компании-партнеры злоупотребляют возможностью безкотрольной нагрузки предоставленного API.
В задании не указанно наличие какого-либо привелигированного положения злоупотребляющих компаний.

## Решение

Необходимо добавить ограничение на пользование бекендом для пользователей и партнеров. Для этого необходимо выбрать предельные значения нагрузки в запросах в секунду и способ контроля. Значения нагрузки дано в задании - 20 RPS.

Все способы контроля сводятся в отбрасыванию запросов преышающих некий лимит и отличаются только способом определения превышения лимита и количеством потребляемой памяти для сбора статистики.

Наиболее дешевым и простым способом является настройка ограничений через nginx-шлюз. Он бесплатный и легко настраивается. Использует метод "фиксированного окна", который плохо контролирует заданаые параметры на границе окон. Его и выбирем

Для лучшего контроля нагрузки можно использовать дырявое ведро, которое будет заполнятся входящими запросами от каждого клиента, отбрасывая те запросы, что превышают нагрузку.
Так же подойдет и ведро токенов.
Но для их внедрения необходимо дорабатывать приложение
При работе с неограниченным кругом пользователей данныно решение может давать большую нагрузку на хранилище токенов. Правила распределения токенов будет сложно подобрать

На первое время можно обойтись решением на основе nginx. Для не анонимных пользователей и партнеров, если данные в запросе позволяют однозначно идентифицировать клиента, настроить ограничения RPS по данному признаку. Для анонимных пользователей добавить общее ограничение на количество соединений или заключить договор с компанией, специализирующейся на таких решниях.

# Георезервирование

У компании есть требования по времени ответа бекенда независимо от географического положения. Такое требование можно особлюсти только добавив геораспределение в проект.

Для чего необходимо создать в каждом метоположении потребителя данных свой набор бекенд-приложений, баз данных и других продуктов. Т.е. локализовать все ресурсы, необходимы для работы конечного пользователя.

Для георезервирования кластера можно или настроить сам кластер или создать два отдельных кластера, на которые трафик будет перенаправлятся специальныи маршрутизатором (GSLB).

Первый вариант требует дополнительной настроки kubernates, добавляет зависимость от системы управления кластером. Появляется необходимость дополнительной настройки распределения приложений по кластеру, дополнительные требования к квалификации инженеров инфраструктуры.

Для реализации второго варианта достаточно развернуть дублирующий кластер из уже существующих настроек и добавить GBSL для перенаправления трафика в зависимости от геолокации.

## Решение

Выбрать в качестве способа георепликации решение на основе двух независимых кластеров kubernates с GSLD в качестве маршрутизатора трафика

# Шардирование БД

Для ускорения работы БД в проект можно добавить разделение БД на секции по признаку принадлежности данных партнеру. Таким образом получиться разделить нагрузку на БД между различными шардами, что уменьшит влияние действий одних партнеров и их клиентов (застрахованных) на других. Но есть опасность, что количество клиентов у каждой страховой сильно разнится. Тогда некоторые сервера БД будут нагружаться больше остальных.

Разделение по региону точно не подходит, т.к. в таком случае в каждом региональном ЦОД будет нагружаться только одна секция - региональная

Если разделять по пользователям, то количество секций может оказаться слишком большим

Для определения необходимости разделения и более точного определения условия разделения необходимо исследование данных. Предположим, что количество данных у каждой страховой примерно равны во всех регионах.

# План восстановления

В связи с тем, что к системе предъявляются жесткие требования к доступности, отсуствуют ограничения на бюджет, то была выбрана стратешия Active-Active.

Остальные стратегии требуют большого или очень большого времени восстановления.